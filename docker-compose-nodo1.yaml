# =============================================================================
# NODO 1 - Keycloak HA con Infinispan
# Despliegue local/producción con PostgreSQL + Keycloak
# =============================================================================

volumes:
  postgres_data:
    driver: local
  etcd_data:
    driver: local

networks:
  keycloak_net:
    external: true

services:
  # =============================================================================
  # etcd - Distributed Configuration Store for Patroni
  # =============================================================================
  etcd:
    image: quay.io/coreos/etcd:v3.5.10
    container_name: etcd-nodo1
    hostname: etcd-nodo1
    restart: unless-stopped
    
    command:
      - etcd
      - --name=etcd-nodo1
      - --data-dir=/etcd-data
      - --listen-client-urls=http://0.0.0.0:2379
      - --advertise-client-urls=http://etcd-nodo1:2379
      - --listen-peer-urls=http://0.0.0.0:2380
      - --initial-advertise-peer-urls=http://etcd-nodo1:2380
      - --initial-cluster=etcd-nodo1=http://etcd-nodo1:2380,etcd-nodo2=http://etcd-nodo2:2380
      - --initial-cluster-state=new
      - --initial-cluster-token=keycloak-etcd-cluster
    
    volumes:
      - etcd_data:/etcd-data
    
    networks:
      - keycloak_net
    
    healthcheck:
      test: ["CMD", "etcdctl", "endpoint", "health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # =============================================================================
  # PostgreSQL para Keycloak NODO 1 (gestionado por Patroni)
  # =============================================================================
  postgres:
    build:
      context: .
      dockerfile: Dockerfile.patroni
    image: keycloak_ha-patroni:latest
    container_name: postgres-nodo1
    hostname: postgres-nodo1
    restart: unless-stopped
    
    depends_on:
      etcd:
        condition: service_healthy
    
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_ADMIN_PASSWORD:-postgres_admin}
      PGDATA: /home/postgres/pgdata/data
    
    volumes:
      - postgres_data:/home/postgres/pgdata
      - ./patroni/patroni-nodo1.yml:/etc/patroni/patroni.yml:ro
    
    networks:
      - keycloak_net
    
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8008/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # =============================================================================
  # HAProxy - Automatic routing to PostgreSQL PRIMARY
  # =============================================================================
  haproxy:
    image: haproxy:2.9-alpine
    container_name: haproxy-nodo1
    hostname: haproxy-nodo1
    restart: unless-stopped
    
    depends_on:
      postgres:
        condition: service_healthy
    
    volumes:
      - ./haproxy/haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro
    
    networks:
      - keycloak_net
    
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://127.0.0.1:7000 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # =============================================================================
  # Keycloak NODO 1 con Infinispan Clustering
  # =============================================================================
  keycloak:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: keycloak-nodo1
    hostname: keycloak-nodo1
    restart: unless-stopped
    
    depends_on:
      haproxy:
        condition: service_healthy
    
    environment:
      # Admin credentials
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN:-admin}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD:-admin}
      
      # Database configuration
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://haproxy-nodo1:5432/keycloak
      KC_DB_USERNAME: keycloak
      KC_DB_PASSWORD: ${POSTGRES_PASSWORD:-keycloak_secret}
      KC_DB_SCHEMA: public
      
      # Hostname configuration
      KC_HOSTNAME_STRICT: "false"
      KC_HOSTNAME_STRICT_HTTPS: "false"
      KC_HTTP_ENABLED: "false"
      
      # HTTPS/TLS configuration
      KC_HTTPS_ENABLED: "true"
      KC_HTTPS_PORT: "8443"
      KC_HTTPS_CERTIFICATE_FILE: /opt/keycloak/conf/tls.crt
      KC_HTTPS_CERTIFICATE_KEY_FILE: /opt/keycloak/conf/tls.key
      
      # High Availability - Infinispan Clustering
      KC_CACHE: ispn
      KC_CACHE_STACK: tcp
      
      # JGroups discovery (TCPPING para producción sin multicast)
      JGROUPS_DISCOVERY_PROTOCOL: TCPPING
      JGROUPS_DISCOVERY_PROPERTIES: initial_hosts="keycloak-nodo1[7800]\\,keycloak-nodo2[7800]",port_range=0
      
      # Logging
      KC_LOG_LEVEL: ${KC_LOG_LEVEL:-info}
      KC_LOG_CONSOLE_OUTPUT: default
      
      # Health and metrics
      KC_HEALTH_ENABLED: "true"
      KC_METRICS_ENABLED: "true"
      
      # Performance tuning
      JAVA_OPTS_APPEND: >-
        -XX:+UseG1GC
        -XX:MaxGCPauseMillis=200
        -XX:+DisableExplicitGC
        -Djava.net.preferIPv4Stack=true
        -Djgroups.tcp.port=7800
    
    ports:
      - "${KC_PORT:-8443}:8443"    # HTTPS Keycloak
      - "${JGROUPS_PORT:-7800}:7800"  # JGroups clustering
    
    volumes:
      - ./certs/tls.crt:/opt/keycloak/conf/tls.crt:ro
      - ./certs/tls.key:/opt/keycloak/conf/tls.key:ro
    
    networks:
      - keycloak_net
    
    healthcheck:
      test: ["CMD-SHELL", "curl -f -k https://localhost:8443/health/ready || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
