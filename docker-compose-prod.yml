version: '3.8'

volumes:
  postgres_data:
    driver: local

networks:
  keycloak-ha-net:
    driver: bridge

services:
  # PostgreSQL compartida para ambos nodos
  postgres:
    image: postgres:15
    container_name: keycloak-postgres-prod
    environment:
      POSTGRES_DB: keycloak
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD: ${KC_DB_PASSWORD:-keycloak_password}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - keycloak-ha-net
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U keycloak"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Keycloak Node 1
  keycloak-1:
    image: quay.io/keycloak/keycloak:23.0
    container_name: keycloak-node-1-prod
    hostname: keycloak-node-1
    command:
      - start
      - --optimized
      - --features=preview
    environment:
      # Admin credentials
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN:-admin}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD:-admin}
      
      # Hostname configuration
      KC_HOSTNAME: ${KC_HOSTNAME:-localhost}
      KC_HOSTNAME_PORT: ${KC_HOSTNAME_PORT:-8443}
      KC_HOSTNAME_STRICT: false
      KC_HOSTNAME_STRICT_BACKCHANNEL: false
      KC_HOSTNAME_STRICT_HTTPS: true
      
      # HTTPS/SSL Configuration
      KC_HTTPS_ENABLED: true
      KC_HTTPS_PORT: 8443
      KC_HTTPS_KEY_STORE_FILE: /opt/keycloak/conf/keycloak.p12
      KC_HTTPS_KEY_STORE_PASSWORD: ${KEY_STORE_PASS:-changeit}
      KC_HTTPS_KEY_STORE_TYPE: PKCS12
      
      # Database configuration
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://postgres:5432/keycloak
      KC_DB_USERNAME: keycloak
      KC_DB_PASSWORD: ${KC_DB_PASSWORD:-keycloak_password}
      KC_DB_POOL_INITIAL_SIZE: 5
      KC_DB_POOL_MIN_SIZE: 5
      KC_DB_POOL_MAX_SIZE: 20
      
      # Cache configuration - Infinispan clustering
      KC_CACHE: ispn
      KC_CACHE_STACK: tcp
      
      # JGroups configuration for clustering
      JAVA_OPTS_APPEND: >-
        -Djgroups.bind.address=SITE_LOCAL
        -Djava.net.preferIPv4Stack=true
        -Djgroups.tcp.address=keycloak-node-1
        -Djgroups.tcp.port=7800
        -Djgroups.discovery.protocol=TCPPING
        -Djgroups.tcpping.initial_hosts=keycloak-node-1[7800],keycloak-node-2[7800]
      
      # Health and metrics
      KC_HEALTH_ENABLED: true
      KC_METRICS_ENABLED: true
      
      # Logging
      KC_LOG_LEVEL: INFO
      
    ports:
      - "8443:8443"  # HTTPS
      - "7800:7800"  # JGroups clustering
    volumes:
      - ./certs/keycloak.p12:/opt/keycloak/conf/keycloak.p12:ro
    networks:
      - keycloak-ha-net
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "exec 3<>/dev/tcp/localhost/8443"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s

  # Keycloak Node 2
  keycloak-2:
    image: quay.io/keycloak/keycloak:23.0
    container_name: keycloak-node-2-prod
    hostname: keycloak-node-2
    command:
      - start
      - --optimized
      - --features=preview
    environment:
      # Admin credentials
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN:-admin}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD:-admin}
      
      # Hostname configuration (same as node 1)
      KC_HOSTNAME: ${KC_HOSTNAME:-localhost}
      KC_HOSTNAME_PORT: ${KC_HOSTNAME_PORT:-8444}
      KC_HOSTNAME_STRICT: false
      KC_HOSTNAME_STRICT_BACKCHANNEL: false
      KC_HOSTNAME_STRICT_HTTPS: true
      
      # HTTPS/SSL Configuration
      KC_HTTPS_ENABLED: true
      KC_HTTPS_PORT: 8443
      KC_HTTPS_KEY_STORE_FILE: /opt/keycloak/conf/keycloak.p12
      KC_HTTPS_KEY_STORE_PASSWORD: ${KEY_STORE_PASS:-changeit}
      KC_HTTPS_KEY_STORE_TYPE: PKCS12
      
      # Database configuration (same database!)
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://postgres:5432/keycloak
      KC_DB_USERNAME: keycloak
      KC_DB_PASSWORD: ${KC_DB_PASSWORD:-keycloak_password}
      KC_DB_POOL_INITIAL_SIZE: 5
      KC_DB_POOL_MIN_SIZE: 5
      KC_DB_POOL_MAX_SIZE: 20
      
      # Cache configuration - Infinispan clustering
      KC_CACHE: ispn
      KC_CACHE_STACK: tcp
      
      # JGroups configuration for clustering
      JAVA_OPTS_APPEND: >-
        -Djgroups.bind.address=SITE_LOCAL
        -Djava.net.preferIPv4Stack=true
        -Djgroups.tcp.address=keycloak-node-2
        -Djgroups.tcp.port=7800
        -Djgroups.discovery.protocol=TCPPING
        -Djgroups.tcpping.initial_hosts=keycloak-node-1[7800],keycloak-node-2[7800]
      
      # Health and metrics
      KC_HEALTH_ENABLED: true
      KC_METRICS_ENABLED: true
      
      # Logging
      KC_LOG_LEVEL: INFO
      
    ports:
      - "8444:8443"  # HTTPS (different external port)
      - "7801:7800"  # JGroups clustering
    volumes:
      - ./certs/keycloak.p12:/opt/keycloak/conf/keycloak.p12:ro
    networks:
      - keycloak-ha-net
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "exec 3<>/dev/tcp/localhost/8443"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s

  # Nginx Load Balancer (Opcional pero recomendado)
  nginx:
    image: nginx:alpine
    container_name: keycloak-loadbalancer
    ports:
      - "443:443"   # HTTPS p√∫blico
      - "80:80"     # HTTP (redirect a HTTPS)
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./certs/nginx.crt:/etc/nginx/ssl/nginx.crt:ro
      - ./certs/nginx.key:/etc/nginx/ssl/nginx.key:ro
    networks:
      - keycloak-ha-net
    depends_on:
      - keycloak-1
      - keycloak-2
