# =============================================================================
# HAProxy Configuration - NODO 2
# PRIMARY remoto (NODO 1) + REPLICA local
# =============================================================================

global
    log 127.0.0.1 local0
    maxconn 4096
    daemon

defaults
    log     global
    mode    tcp
    option  tcplog
    option  dontlognull
    retries 3
    timeout connect 10000ms  # Mayor timeout para conexiones remotas
    timeout client  50000ms
    timeout server  50000ms

# =============================================================================
# Stats Page
# =============================================================================
listen stats
    bind *:7000
    mode http
    stats enable
    stats uri /
    stats realm HAProxy\ Statistics
    stats refresh 5s
    stats show-legends
    stats show-node

# =============================================================================
# Frontend PRIMARY (Puerto 5000)
# Proxy a PRIMARY remoto (NODO 1)
# =============================================================================
frontend pg_primary
    bind *:5000
    mode tcp
    default_backend pg_primary_backend

backend pg_primary_backend
    mode tcp
    option pgsql-check user postgres
    
    # PRIMARY remoto (NODO 1)
    # ⚠️ Será resuelto via extra_hosts en docker-compose
    server nodo1-primary nodo1-primary:5432 check inter 10s rise 2 fall 3

# =============================================================================
# Frontend REPLICA (Puerto 5001)
# REPLICA local
# =============================================================================
frontend pg_replica
    bind *:5001
    mode tcp
    default_backend pg_replica_backend

backend pg_replica_backend
    mode tcp
    option pgsql-check user postgres
    
    # REPLICA local (mismo NODO 2)
    server postgres-replica postgres-replica:5432 check inter 5s rise 2 fall 3
