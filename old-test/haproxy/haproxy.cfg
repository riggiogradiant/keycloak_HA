# =============================================================================
# HAProxy para PostgreSQL Streaming Replication
#
# NOTA: PostgreSQL usa protocolo binario, por lo que HAProxy no puede
#       inspeccionar queries SQL de manera confiable para routing automático.
#
# Solución práctica:
#   - Puerto 5000: PRIMARY (escrituras garantizadas)
#   - Puerto 5001: REPLICA preferida (lecturas), PRIMARY como backup
#
# Para routing automático de escrituras, se requiere PgBouncer o pgpool-II
# =============================================================================

global
    maxconn 4096
    log stdout format raw local0 info

defaults
    log     global
    mode    tcp
    retries 3
    timeout connect 10s
    timeout client  1h
    timeout server  1h
    timeout check   5s

# =============================================================================
# Panel de estadísticas
# =============================================================================
listen stats
    mode http
    bind *:7000
    stats enable
    stats uri /
    stats refresh 5s
    stats show-legends
    stats show-desc Keycloak HA - PostgreSQL Replication Status
    stats admin if TRUE

# =============================================================================
# Frontend PRIMARY (puerto 5000)
# SIEMPRE va al PRIMARY para garantizar escrituras
# =============================================================================
frontend postgres_primary_frontend
    bind *:5000
    default_backend pg_primary_backend

# =============================================================================
# Frontend REPLICA (puerto 5001) 
# Preferencia: REPLICA → PRIMARY (backup)
# Úsalo solo para SELECTs, escrituras pueden fallar si va a REPLICA
# =============================================================================
frontend postgres_replica_frontend
    bind *:5001
    default_backend pg_replica_backend

# =============================================================================
# Backend PRIMARY
# Detecta automáticamente qué nodo es PRIMARY después de failover
# =============================================================================
backend pg_primary_backend
    mode tcp
    balance roundrobin
    option pgsql-check user postgres
    
    default-server inter 3s fall 3 rise 2 on-marked-down shutdown-sessions
    
    # Nodo 1: Normalmente PRIMARY
    server node1 postgres-primary:5432 check
    
    # Nodo 2: Backup (se activa si node1 cae o fue promovida)
    server node2 postgres-replica:5432 check backup

# =============================================================================
# Backend REPLICA (lecturas)
# Prioridad a REPLICA, usa PRIMARY solo si REPLICA no disponible
# =============================================================================
backend pg_replica_backend
    mode tcp
    balance roundrobin
    option pgsql-check user postgres
    
    default-server inter 3s fall 3 rise 2
    
    # REPLICA: Primera opción para lecturas
    server node2 postgres-replica:5432 check weight 100
    
    # PRIMARY: Backup si REPLICA no disponible
    server node1 postgres-primary:5432 check weight 50 backup
