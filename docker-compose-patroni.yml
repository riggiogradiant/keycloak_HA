volumes:
  postgres_data_node1:
  postgres_data_node2:
  etcd_data_node1:
  etcd_data_node2:

networks:
  keycloak-net:
    driver: bridge

services:
  # ============================================
  # ETCD CLUSTER (DCS para Patroni)
  # ============================================
  
  etcd-node1:
    image: quay.io/coreos/etcd:v3.5.12
    container_name: etcd-node1
    hostname: etcd-node1
    environment:
      - ETCD_NAME=etcd-node1
      - ETCD_INITIAL_CLUSTER=etcd-node1=http://etcd-node1:2380,etcd-node2=http://etcd-node2:2380
      - ETCD_INITIAL_CLUSTER_STATE=new
      - ETCD_INITIAL_CLUSTER_TOKEN=keycloak-etcd-cluster
      - ETCD_INITIAL_ADVERTISE_PEER_URLS=http://etcd-node1:2380
      - ETCD_ADVERTISE_CLIENT_URLS=http://etcd-node1:2379
      - ETCD_LISTEN_PEER_URLS=http://0.0.0.0:2380
      - ETCD_LISTEN_CLIENT_URLS=http://0.0.0.0:2379
      - ETCD_DATA_DIR=/etcd-data
    volumes:
      - etcd_data_node1:/etcd-data
    ports:
      - "2379:2379"
      - "2380:2380"
    networks:
      - keycloak-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "etcdctl", "endpoint", "health"]
      interval: 10s
      timeout: 5s
      retries: 5

  etcd-node2:
    image: quay.io/coreos/etcd:v3.5.12
    container_name: etcd-node2
    hostname: etcd-node2
    environment:
      - ETCD_NAME=etcd-node2
      - ETCD_INITIAL_CLUSTER=etcd-node1=http://etcd-node1:2380,etcd-node2=http://etcd-node2:2380
      - ETCD_INITIAL_CLUSTER_STATE=new
      - ETCD_INITIAL_CLUSTER_TOKEN=keycloak-etcd-cluster
      - ETCD_INITIAL_ADVERTISE_PEER_URLS=http://etcd-node2:2380
      - ETCD_ADVERTISE_CLIENT_URLS=http://etcd-node2:2379
      - ETCD_LISTEN_PEER_URLS=http://0.0.0.0:2380
      - ETCD_LISTEN_CLIENT_URLS=http://0.0.0.0:2379
      - ETCD_DATA_DIR=/etcd-data
    volumes:
      - etcd_data_node2:/etcd-data
    ports:
      - "23791:2379"
      - "23801:2380"
    networks:
      - keycloak-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "etcdctl", "endpoint", "health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================
  # PATRONI + POSTGRESQL CLUSTER
  # ============================================

  patroni-node1:
    image: flant/spilo:2.0-p1-11.10
    container_name: patroni-node1
    hostname: patroni-node1
    environment:
      - SCOPE=keycloak-cluster
      - PGVERSION=11
      - ETCD3_HOST=etcd-node1:2379
      - PATRONI_NAME=patroni-node1
      - PATRONI_SUPERUSER_PASSWORD=postgres_admin
      - PATRONI_REPLICATION_USERNAME=replicator
      - PATRONI_REPLICATION_PASSWORD=replicator_pass
    volumes:
      - postgres_data_node1:/home/postgres/pgdata
    ports:
      - "5432:5432"
      - "8008:8008"
    networks:
      - keycloak-net
    depends_on:
      etcd-node1:
        condition: service_healthy
      etcd-node2:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10

  patroni-node2:
    image: flant/spilo:2.0-p1-11.10
    container_name: patroni-node2
    hostname: patroni-node2
    environment:
      - SCOPE=keycloak-cluster
      - PGVERSION=11
      - ETCD3_HOST=etcd-node1:2379
      - PATRONI_NAME=patroni-node2
      - PATRONI_SUPERUSER_PASSWORD=postgres_admin
      - PATRONI_REPLICATION_USERNAME=replicator
      - PATRONI_REPLICATION_PASSWORD=replicator_pass
    volumes:
      - postgres_data_node2:/home/postgres/pgdata
    ports:
      - "5433:5432"
      - "8009:8008"
    networks:
      - keycloak-net
    depends_on:
      etcd-node1:
        condition: service_healthy
      etcd-node2:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10

  # ============================================
  # KEYCLOAK CLUSTER + INFINISPAN
  # ============================================

  keycloak-1:
    build: .
    container_name: keycloak-1
    hostname: keycloak-1
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://patroni-node1:5432/keycloak
      KC_DB_USERNAME: keycloak
      KC_DB_PASSWORD: keycloak
      KC_HOSTNAME: localhost
      KC_HOSTNAME_STRICT: false
      KC_HTTPS_ENABLED: true
      KC_HTTPS_PORT: 8443
      KC_HTTPS_KEY_STORE_FILE: /opt/keycloak/conf/keycloak.p12
      KC_HTTPS_KEY_STORE_PASSWORD: changeit
      KC_HTTPS_KEY_STORE_TYPE: PKCS12
      KC_CACHE: ispn
      KC_CACHE_STACK: tcp
      JAVA_OPTS_APPEND: >-
        -Djgroups.bind_addr=keycloak-1
        -Djgroups.tcpping.initial_hosts=keycloak-1[7800],keycloak-2[7800]
        -Djava.net.preferIPv4Stack=true
    ports:
      - "8443:8443"
      - "7800:7800"
    volumes:
      - ./certs/keycloak.p12:/opt/keycloak/conf/keycloak.p12:ro
    networks:
      - keycloak-net
    depends_on:
      patroni-node1:
        condition: service_healthy
      patroni-node2:
        condition: service_healthy
    restart: unless-stopped

  keycloak-2:
    build: .
    container_name: keycloak-2
    hostname: keycloak-2
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://patroni-node2:5432/keycloak
      KC_DB_USERNAME: keycloak
      KC_DB_PASSWORD: keycloak
      KC_HOSTNAME: localhost
      KC_HOSTNAME_STRICT: false
      KC_HTTPS_ENABLED: true
      KC_HTTPS_PORT: 8443
      KC_HTTPS_KEY_STORE_FILE: /opt/keycloak/conf/keycloak.p12
      KC_HTTPS_KEY_STORE_PASSWORD: changeit
      KC_HTTPS_KEY_STORE_TYPE: PKCS12
      KC_CACHE: ispn
      KC_CACHE_STACK: tcp
      JAVA_OPTS_APPEND: >-
        -Djgroups.bind_addr=keycloak-2
        -Djgroups.tcpping.initial_hosts=keycloak-1[7800],keycloak-2[7800]
        -Djava.net.preferIPv4Stack=true
    ports:
      - "8444:8443"
      - "7801:7800"
    volumes:
      - ./certs/keycloak.p12:/opt/keycloak/conf/keycloak.p12:ro
    networks:
      - keycloak-net
    depends_on:
      patroni-node1:
        condition: service_healthy
      patroni-node2:
        condition: service_healthy
    restart: unless-stopped
