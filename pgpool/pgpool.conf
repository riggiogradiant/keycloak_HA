# =============================================================================
# pgpool-II Configuration - Query Routing Automático
#
# Redirige automáticamente:
#   - SELECT → REPLICA (load balance)
#   - INSERT/UPDATE/DELETE → PRIMARY
# =============================================================================

# ============================================
# LISTEN SETTINGS
# ============================================
listen_addresses = '*'
port = 9999
socket_dir = '/var/run/postgresql'
pcp_listen_addresses = '*'
pcp_port = 9898

# ============================================
# BACKEND CONNECTIONS
# ============================================
# Backend 0: PRIMARY (via HAProxy)
backend_hostname0 = 'haproxy'
backend_port0 = 5000
backend_weight0 = 0      # Weight 0 = no SELECT load balancing a PRIMARY (solo escrituras)
backend_data_directory0 = '/var/lib/postgresql/data'
backend_flag0 = 'ALWAYS_PRIMARY'
backend_application_name0 = 'primary'

# Backend 1: REPLICA (via HAProxy)  
backend_hostname1 = 'haproxy'
backend_port1 = 5001
backend_weight1 = 1      # Weight 1 = todo el SELECT load balancing va aquí
backend_data_directory1 = '/var/lib/postgresql/data'
backend_flag1 = 'DISALLOW_TO_FAILOVER'
backend_application_name1 = 'replica'

# ============================================
# AUTHENTICATION
# ============================================
enable_pool_hba = off
allow_clear_text_frontend_auth = on

# ============================================
# CONNECTION POOLING
# ============================================
num_init_children = 32
max_pool = 4
child_life_time = 300
child_max_connections = 0
connection_life_time = 0
client_idle_limit = 0

# ============================================
# LOAD BALANCING MODE (QUERY ROUTING)
# ============================================
load_balance_mode = on
ignore_leading_white_space = on

# Statements to be load balanced
black_function_list = ''
white_function_list = ''

# Statements NOT to be load balanced (siempre PRIMARY)
black_query_pattern_list = ''

# ============================================
# WRITE QUERY DETECTION
# ============================================
# Detectar queries de escritura y enviarlas al PRIMARY
disable_load_balance_on_write = 'transaction'

# Queries DML siempre al PRIMARY
# Nota: pgpool detecta automáticamente INSERT, UPDATE, DELETE, etc.

# ============================================
# PRIMARY/REPLICA MODE
# ============================================
master_slave_mode = on
master_slave_sub_mode = 'stream'

# ============================================
# STREAMING REPLICATION CHECK
# ============================================
sr_check_period = 10
sr_check_user = 'postgres'
sr_check_password = 'postgres_admin'
sr_check_database = 'postgres'

# ============================================
# HEALTH CHECK
# ============================================
health_check_period = 10
health_check_timeout = 20
health_check_user = 'postgres'
health_check_password = 'postgres_admin'
health_check_database = 'postgres'
health_check_max_retries = 3
health_check_retry_delay = 1

# ============================================
# FAILOVER AND FAILBACK
# ============================================
failover_command = ''
failback_command = ''
failover_on_backend_error = off
detach_false_primary = off

# ============================================
# ONLINE RECOVERY
# ============================================
recovery_user = 'postgres'
recovery_password = 'postgres_admin'
recovery_1st_stage_command = ''
recovery_2nd_stage_command = ''

# ============================================
# WATCHDOG (DISABLED)
# ============================================
use_watchdog = off

# ============================================
# LOGGING
# ============================================
log_destination = 'stderr'
log_line_prefix = '%t: pid %p: '
log_connections = on
log_disconnections = on
log_hostname = on
log_statement = off
log_per_node_statement = off
log_client_messages = on
log_standby_delay = 'if_over_threshold'

# ============================================
# MEMORY CACHE (DISABLED)
# ============================================
memory_cache_enabled = off

# ============================================
# OTHERS
# ============================================
relcache_expire = 0
relcache_size = 256

# ============================================
# STATEMENT LEVEL LOAD BALANCE
# ============================================
# Funciones que siempre deben ir al PRIMARY
primary_routing_query_pattern_list = 'COPY;INSERT;UPDATE;DELETE;LOCK;CREATE;DROP;ALTER;TRUNCATE;GRANT;REVOKE'

# ============================================
# IN MEMORY QUERY CACHE
# ============================================
enable_shared_relcache = on
relcache_query_target = 'primary'
