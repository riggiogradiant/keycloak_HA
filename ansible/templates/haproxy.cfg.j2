# =============================================================================
# HAProxy Configuration for Keycloak HA
# Generated by Ansible for multi-host deployment
# Uses static IPs (no Docker DNS resolver needed)
# =============================================================================

global
    maxconn 100
    log stdout local0

defaults
    log global
    mode tcp
    retries 2
    timeout client 30m
    timeout connect 4s
    timeout server 30m
    timeout check 5s

# Statistics page
listen stats
    mode http
    bind *:{{ haproxy_stats_port }}
    stats enable
    stats uri /

# Primary PostgreSQL endpoint (routes to PRIMARY node only)
listen postgres_primary
    bind *:{{ haproxy_postgres_port }}
    option tcplog
    option httpchk OPTIONS /master
    http-check expect status 200
    default-server inter 3s fall 3 rise 2 on-marked-down shutdown-sessions
{% for host in groups['postgres_cluster'] %}
    server {{ hostvars[host]['postgres_name'] }} {{ hostvars[host]['internal_ip'] }}:{{ hostvars[host]['postgres_port'] }} maxconn 100 check port {{ hostvars[host]['patroni_api_port'] }}
{% endfor %}

# Replica PostgreSQL endpoint (routes to REPLICA nodes only)
listen postgres_replicas
    bind *:{{ haproxy_replica_port }}
    option tcplog
    option httpchk OPTIONS /replica
    http-check expect status 200
    default-server inter 3s fall 3 rise 2 on-marked-down shutdown-sessions
{% for host in groups['postgres_cluster'] %}
    server {{ hostvars[host]['postgres_name'] }} {{ hostvars[host]['internal_ip'] }}:{{ hostvars[host]['postgres_port'] }} maxconn 100 check port {{ hostvars[host]['patroni_api_port'] }}
{% endfor %}
