# =============================================================================
# Docker Compose - {{ node_name | upper }}
# Generated by Ansible for multi-host Keycloak HA deployment
# Uses network_mode: "host" with static IPs (no Docker networks needed)
# =============================================================================

volumes:
  postgres_data:
    driver: local
  etcd_data:
    driver: local

services:
  # =============================================================================
  # etcd - Distributed Configuration Store for Patroni
  # =============================================================================
  etcd:
    image: {{ etcd_image }}
    container_name: {{ etcd_name }}
    hostname: {{ etcd_name }}
    restart: unless-stopped
    network_mode: "host"
    
    command:
      - etcd
      - --name={{ etcd_name }}
      - --data-dir=/etcd-data
      - --listen-client-urls=http://0.0.0.0:{{ etcd_client_port }}
      - --advertise-client-urls=http://{{ internal_ip }}:{{ etcd_client_port }}
      - --listen-peer-urls=http://0.0.0.0:{{ etcd_peer_port }}
      - --initial-advertise-peer-urls=http://{{ internal_ip }}:{{ etcd_peer_port }}
      - --initial-cluster={% for host in groups['etcd_cluster'] %}{{ hostvars[host]['etcd_name'] }}=http://{{ hostvars[host]['internal_ip'] }}:{{ hostvars[host]['etcd_peer_port'] }}{% if not loop.last %},{% endif %}{% endfor %}

      - --initial-cluster-state={{ etcd_initial_cluster_state }}
      - --initial-cluster-token={{ etcd_cluster_token }}
    
    volumes:
      - etcd_data:/etcd-data
    
    healthcheck:
      test: ["CMD", "etcdctl", "endpoint", "health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # =============================================================================
  # PostgreSQL para Keycloak (gestionado por Patroni)
  # =============================================================================
  postgres:
    image: keycloak_ha-patroni:latest
    container_name: {{ postgres_name }}
    hostname: {{ postgres_name }}
    restart: unless-stopped
    network_mode: "host"
    
    depends_on:
      etcd:
        condition: service_healthy
    
    environment:
      POSTGRES_PASSWORD: {{ postgres_admin_password }}
      PGDATA: /home/postgres/pgdata/data
    
    volumes:
      - postgres_data:/home/postgres/pgdata
      - {{ deployment_dir }}/patroni/patroni.yml:/etc/patroni/patroni.yml:ro
      - {{ deployment_dir }}/patroni/post_init.sh:/etc/patroni/post_init.sh:ro
    
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:{{ patroni_api_port }}/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # =============================================================================
  # HAProxy - Automatic routing to PostgreSQL PRIMARY
  # =============================================================================
  haproxy:
    image: {{ haproxy_image }}
    container_name: {{ haproxy_name }}
    hostname: {{ haproxy_name }}
    restart: unless-stopped
    network_mode: "host"
    
    depends_on:
      postgres:
        condition: service_healthy
    
    volumes:
      - {{ deployment_dir }}/haproxy/haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro
    
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://127.0.0.1:{{ haproxy_stats_port }} || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # =============================================================================
  # Keycloak con Infinispan Clustering
  # =============================================================================
  keycloak:
    image: keycloak_ha-keycloak:latest
    container_name: {{ keycloak_name }}
    hostname: {{ keycloak_name }}
    restart: unless-stopped
    network_mode: "host"
    
    depends_on:
      haproxy:
        condition: service_healthy
    
    environment:
      # Admin credentials
      KEYCLOAK_ADMIN: {{ keycloak_admin }}
      KEYCLOAK_ADMIN_PASSWORD: {{ keycloak_admin_password }}
      
      # Database configuration - connects to LOCAL HAProxy via internal IP
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://{{ internal_ip }}:{{ haproxy_postgres_port }}/{{ postgres_db }}
      KC_DB_USERNAME: {{ postgres_keycloak_user }}
      KC_DB_PASSWORD: {{ postgres_keycloak_password }}
      KC_DB_SCHEMA: public
      
      # Hostname configuration
      KC_HOSTNAME_STRICT: "false"
      KC_HOSTNAME_STRICT_HTTPS: "false"
      KC_HTTP_ENABLED: "false"
      
      # HTTPS/TLS configuration
      KC_HTTPS_ENABLED: "true"
      KC_HTTPS_PORT: "{{ keycloak_https_port }}"
      KC_HTTPS_CERTIFICATE_FILE: /opt/keycloak/conf/tls.crt
      KC_HTTPS_CERTIFICATE_KEY_FILE: /opt/keycloak/conf/tls.key
      
      # Logging
      KC_LOG_LEVEL: {{ keycloak_log_level }}
      
      # Clustering con Infinispan (JGroups TCP mode with TCPPING discovery)
      KC_CACHE: ispn
      KC_CACHE_STACK: tcp
      JGROUPS_DISCOVERY_PROTOCOL: TCPPING
      JGROUPS_DISCOVERY_PROPERTIES: initial_hosts="{% for host in groups['keycloak_nodes'] %}{{ hostvars[host]['internal_ip'] }}[{{ hostvars[host]['keycloak_jgroups_port'] }}]{% if not loop.last %}\\,{% endif %}{% endfor %}",port_range=0
      
      # JGroups bind configuration (CRITICAL for network_mode: host)
      JAVA_OPTS_APPEND: "-Djgroups.bind.address={{ internal_ip }} -Djgroups.bind.port={{ keycloak_jgroups_port }} -Djgroups.node.name={{ keycloak_name }} -Djava.net.preferIPv4Stack=true"
      
      # Health & Metrics
      KC_HEALTH_ENABLED: "true"
      KC_METRICS_ENABLED: "true"
      
      # Transaction settings
      KC_TRANSACTION_XA_ENABLED: "false"
    
    volumes:
      - {{ deployment_dir }}/certs/tls.crt:/opt/keycloak/conf/tls.crt:ro
      - {{ deployment_dir }}/certs/tls.key:/opt/keycloak/conf/tls.key:ro
    
    healthcheck:
      test: ["CMD-SHELL", "curl -f -k https://localhost:{{ keycloak_https_port }}/health/ready || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
